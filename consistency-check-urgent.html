<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Consistency Checker Urgent &#8212; FoundationDB ON documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="FoundationDB Range Locks (WiP)" href="rangelock.html" />
    <link rel="prev" title="FDB HA Write Path: How a mutation travels in FDB HA" href="ha-write-path.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.4.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Consistency Checker Urgent</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#key-features">Key features</a></li>
<li><a class="reference internal" href="#how-to-use">How to use?</a></li>
<li><a class="reference internal" href="#compared-to-consistency-checker">Compared to Consistency Checker</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distributed-consistency-checking-model">Distributed consistency-checking model</a><ul>
<li><a class="reference internal" href="#workflow">Workflow</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="ha-write-path.html" title="Previous Chapter: FDB HA Write Path: How a mutation travels in FDB HA"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; FDB HA Write ...</span>
    </a>
  </li>
  <li>
    <a href="rangelock.html" title="Next Chapter: FoundationDB Range Locks (WiP)"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">FoundationDB ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Consistency Checker Urgent</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#key-features">Key features</a></li>
<li><a class="reference internal" href="#how-to-use">How to use?</a></li>
<li><a class="reference internal" href="#compared-to-consistency-checker">Compared to Consistency Checker</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distributed-consistency-checking-model">Distributed consistency-checking model</a><ul>
<li><a class="reference internal" href="#workflow">Workflow</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="consistency-checker-urgent">
<h1>Consistency Checker Urgent</h1>
<div class="line-block">
<div class="line">Author: Zhe Wang</div>
<div class="line">Reviewer: Jingyu Zhou</div>
<div class="line">Audience: FDB developers, SREs and expert users.</div>
</div>
<section id="overview">
<h2>Overview</h2>
<p>In a FoundationDB (FDB) key-value cluster, every key-value pair is replicated across multiple storage servers.
The Consistency Checker Urgent tool can be used to validate the consistency of all replicas for each key-value pair.
If any data inconsistency is detected, the tool generates ConsistencyCheck_DataInconsistent trace events for the corresponding shard.
There are two types of data inconsistencies:</p>
<ol class="arabic simple">
<li><p>Value mismatch, where the value of a key on one server differs from that on another server,</p></li>
<li><p>Unique key, where a key exists on one server but not on another.</p></li>
</ol>
<p>The ConsistencyCheck_DataInconsistent trace event differentiates between these two types of corruption.</p>
<section id="key-features">
<h3>Key features</h3>
<p>The Consistency Checker Urgent tool is designed to ensure safe, fast, and comprehensive checking of data consistency across the entire key space
(i.e., “ “ ~ “\xff\xff”). It achieves this through the following features:</p>
<ul class="simple">
<li><p>End-to-end completeness check — The checker continues until all ranges are marked as complete.</p></li>
<li><p>Scalability — Adding more testers results in nearly linear speedup with the number of testers.</p></li>
<li><p>Progress monitoring — A single trace event (i.e. ConsistencyCheckUrgent_GotShardsToCheck) indicates the remaining number of shards to check.</p></li>
<li><p>Independence from the existing cluster — The tool does not store any data in the cluster being checked.</p></li>
<li><p>Fault tolerance — Tester failures do not impact the checker process. Shard checking failures are automatically retried.</p></li>
<li><p>Workload throttling — Each tester can handle one task at a time, with a maximum read rate of 50MB/s (specified by knob CONSISTENCY_CHECK_RATE_LIMIT_MAX, though the actual value should be much smaller).</p></li>
<li><p>Custom input ranges — Users can specify at most 4 custom ranges in knobs. By default, the knob is set to check the entire key space (i.e., “ “ ~ “\xff\xff”).</p></li>
</ul>
</section>
<section id="how-to-use">
<h3>How to use?</h3>
<p>To run the ConsistencyCheckerUrgent, you need 1 checker and N testers. The process is as follows:</p>
<ul class="simple">
<li><p>If you want to specify ranges to do consistency checker, set ranges via knobs: CONSISTENCY_CHECK_URGENT_RANGE_BEGIN_* and CONSISTENCY_CHECK_URGENT_RANGE_END_*. The custom range’s start and end points must be represented in hexadecimal ASCII format, strictly adhering to the “\\x” prefix (including two escape chars, followed by ‘x’). By default, the knob is set to check the entire key space (i.e., “ “ ~ “\xff\xff”).</p></li>
<li><p>Start N testers (i.e. fdbserver –class test –consistency-check-urgent-mode). When setting consistency-check-urgent-mode, the tester server will check whether the received workload is a “ConsistencyCheckUrgent” workload. If yes, accept the workload. Otherwise, drop the workload with a SevError trace event: StartingTesterServerCoreUnexpectedWorkload.</p></li>
<li><p>Start the checker (i.e. fdbserver -r consistencycheckurgent –num-testers={num-testers}), which initiates the consistency checking automatically.</p></li>
<li><p>Once the checking is complete, the checker exits automatically, leaving the testers alive but idle.</p></li>
<li><p>If you need to rerun the checking, simply restart the checker process.</p></li>
</ul>
<p>Users should manually remove testers when they are no longer needed.
This approach allows for re-running the one-shot checking by restarting the checker process.</p>
</section>
<section id="compared-to-consistency-checker">
<h3>Compared to Consistency Checker</h3>
<p>ConsistencyCheckerUrgent offers significant improvements over the existing consistency checker in several key areas:</p>
<ul class="simple">
<li><p>The existing checker cannot guarantee a complete check, while ConsistencyCheckerUrgent ensures a thorough and complete check.</p></li>
<li><p>The existing checker operates on a single thread, resulting in slow performance. In contrast, ConsistencyCheckerUrgent utilizes a distributed processing model, enabling faster processing. Additionally, adding more resources allows for linear speed improvements.</p></li>
<li><p>The existing checker lacks reliability, as it may silently error out and lose progress. ConsistencyCheckerUrgent, on the other hand, is designed with retriable components and mechanisms, making it much more reliable.</p></li>
<li><p>Tracking progress with the existing checker is challenging. In contrast, ConsistencyCheckerUrgent provides clear progress information.</p></li>
<li><p>The existing checker is limited to checking the entire key space, while ConsistencyCheckerUrgent allows users to specify any key range for checking.</p></li>
</ul>
</section>
</section>
<section id="distributed-consistency-checking-model">
<h2>Distributed consistency-checking model</h2>
<p>The ConsistencyCheckerUrgent system conducts consistency checks in a distributed, client-server manner. It comprises a centralized leader (referred to as the Checker) and N agents (referred to as Testers). The Checker manages the checking process by:</p>
<ul class="simple">
<li><p>Collecting ranges for checking.</p></li>
<li><p>Assigning ranges to agents.</p></li>
<li><p>Collecting results from agents.</p></li>
<li><p>Managing the progress of checking.</p></li>
</ul>
<p>The agents perform consistency checking tasks, comparing every key in the assigned range across all source servers at a specific version. As agents complete tasks or encounter failures, the leader is informed and updates the progress of the checking process accordingly.</p>
<section id="workflow">
<h3>Workflow</h3>
<p>The checker operates in the following steps:</p>
<ol class="arabic simple">
<li><p>Initially, the checker loads ranges to check from knobs (which defaults to “ “ ~ “xffxff”). See: CONSISTENCY_CHECK_URGENT_RANGE_BEGIN_* and CONSISTENCY_CHECK_URGENT_RANGE_END_*.</p></li>
<li><p>The checker contacts the cluster controller (CC) to obtain the tester interfaces.</p></li>
<li><p>The checker continues to contact the CC until it receives a sufficient number of testers (as specified by user input when starting the consistencycheckurgent process: –num-testers).</p></li>
<li><p>After collecting enough testers, the checker partitions the range to be checked according to the shard boundary (shard information is retrieved from the FDB system metadata).</p></li>
<li><p>The checker distributes shards among the selected testers. Each tester is allocated a fixed number of shards at a time (as specified by the knob CONSISTENCY_CHECK_URGENT_BATCH_SHARD_COUNT). Currently, the knob is set to 10 by default and testers are expected to complete these shards by approximately 1 hour.</p></li>
<li><p>The checker sends assignments to the testers, and the testers begin processing their assigned ranges. This is done in batches; the checker sends assignments to all testers simultaneously and waits for replies from all testers. The checker proceeds only after receiving replies from all testers or if a tester fails or crashes.</p></li>
<li><p>When a tester completes its assigned shards, it reports whether it has completed all assigned shards. If so, the checker marks the assigned shards as complete. Otherwise, the checker marks all the assigned shards to that tester as failed and retries them later.</p></li>
<li><p>The checker collects all unfinished shards from memory and returns to step 2.</p></li>
<li><p>When the entire key space is marked as complete, the checker terminates with a single trace event ConsistencyCheckUrgent_Complete.</p></li>
</ol>
<p>The tester operates in the following steps:</p>
<ol class="arabic simple">
<li><p>The tester receives a set of ranges to check from the checker at a time (specified by CONSISTENCY_CHECK_URGENT_BATCH_SHARD_COUNT).</p></li>
<li><p>For each shard, the tester obtains the storage server (SS) interfaces of all data centers.</p></li>
<li><p>The tester issues a read range request to each SS interface, ensuring they are at the same version.</p></li>
<li><p>Key by key, the tester compares the values and records any inconsistencies, populating ConsistencyCheck_DataInconsistent in the presence of shard inconsistency.</p></li>
<li><p>If any keys fail to compare, the tester collects them and retries the comparison process for those keys, returning to step 2.</p></li>
<li><p>Once all shards have been compared or the tester has retried for a specified number of times, the tester notifies the checker.</p></li>
</ol>
</section>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/consistency-check-urgent.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2022 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Apr 11, 2025.<br/>
    </p>
  </div>
</footer>
  </body>
</html>