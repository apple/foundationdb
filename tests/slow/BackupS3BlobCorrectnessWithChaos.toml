testClass = "Backup"

[configuration]
buggify = false
faultInjection = false

# BackupS3BlobCorrectness with S3 Chaos Injection
# This test suite validates that S3 backup and restore operations work correctly
# even when S3 operations experience errors, throttling, delays, and data corruption.
#
# Test Variants:
# - Stable: No chaos (errorRate=0) - baseline for comparison
# - LightChaos: Minimal disruption (5% errors, 10% throttling)
# - MediumChaos: Moderate disruption (15% errors, 20% throttling, 10% delays)
# - HeavyChaos: Aggressive testing (25% errors, 30% throttling, 15% delays, 1% corruption)

[[test]]
testTitle = 'BackupS3BlobCorrectnessStable'
clearAfterTest = false
simBackupAgents = 'BackupToFile'
waitForQuiescenceEnd = false
runConsistencyCheck = false

    [[test.workload]]
    testName = 'Cycle'
    nodeCount = 30000
    transactionsPerSecond = 2500.0
    testDuration = 30.0
    expectedRate = 0

    [[test.workload]]
    testName = 'BackupS3BlobCorrectness'
    backupAfter = 35.0
    restoreAfter = 250.0
    abortAndRestartAfter = 0.0
    stopDifferentialAfter = 0.0
    performRestore = true
    backupRangesCount = -1
    skipDirtyRestore = false
    backupURL = 'blobstore://mocks3:mocksecret:mocktoken@127.0.0.1:8080/backup_container?bucket=backup_bucket&region=us-east-1&secure_connection=0&cwpf=1&cu=1'
    # Enable chaos infrastructure but with zero chaos rates (stable baseline)
    enableChaos = true
    errorRate = 0.0
    throttleRate = 0.0
    delayRate = 0.0
    corruptionRate = 0.0
    maxDelay = 0.0

    [[test.workload]]
    testName = 'RandomClogging'
    testDuration = 300.0

    [[test.workload]]
    testName = 'Rollback'
    meanDelay = 90.0
    testDuration = 300.0

[[test]]
testTitle = 'BackupS3BlobCorrectnessLightChaos'
clearAfterTest = false
simBackupAgents = 'BackupToFile'
waitForQuiescenceEnd = false
runConsistencyCheck = false

    [[test.workload]]
    testName = 'Cycle'
    nodeCount = 30000
    transactionsPerSecond = 2500.0
    testDuration = 30.0
    expectedRate = 0

    [[test.workload]]
    testName = 'BackupS3BlobCorrectness'
    backupAfter = 35.0
    restoreAfter = 250.0
    abortAndRestartAfter = 0.0
    stopDifferentialAfter = 0.0
    performRestore = true
    backupRangesCount = -1
    skipDirtyRestore = false
    backupURL = 'blobstore://mocks3:mocksecret:mocktoken@127.0.0.1:8080/backup_container?bucket=backup_bucket&region=us-east-1&secure_connection=0&cwpf=1&cu=1'
    # Light chaos: minimal disruption to validate basic error handling
    enableChaos = true
    errorRate = 0.05
    throttleRate = 0.10
    delayRate = 0.0
    corruptionRate = 0.0
    maxDelay = 0.0

    [[test.workload]]
    testName = 'RandomClogging'
    testDuration = 300.0

    [[test.workload]]
    testName = 'Rollback'
    meanDelay = 90.0
    testDuration = 300.0

[[test]]
testTitle = 'BackupS3BlobCorrectnessMediumChaos'
clearAfterTest = false
simBackupAgents = 'BackupToFile'
waitForQuiescenceEnd = false
runConsistencyCheck = false

    [[test.workload]]
    testName = 'Cycle'
    nodeCount = 30000
    transactionsPerSecond = 2500.0
    testDuration = 30.0
    expectedRate = 0

    [[test.workload]]
    testName = 'BackupS3BlobCorrectness'
    backupAfter = 35.0
    restoreAfter = 250.0
    abortAndRestartAfter = 0.0
    stopDifferentialAfter = 0.0
    performRestore = true
    backupRangesCount = -1
    skipDirtyRestore = false
    backupURL = 'blobstore://mocks3:mocksecret:mocktoken@127.0.0.1:8080/backup_container?bucket=backup_bucket&region=us-east-1&secure_connection=0&cwpf=1&cu=1'
    # Medium chaos: moderate disruption with delays
    enableChaos = true
    errorRate = 0.15
    throttleRate = 0.20
    delayRate = 0.10
    corruptionRate = 0.0
    maxDelay = 5.0

    [[test.workload]]
    testName = 'RandomClogging'
    testDuration = 300.0

    [[test.workload]]
    testName = 'Rollback'
    meanDelay = 90.0
    testDuration = 300.0

[[test]]
testTitle = 'BackupS3BlobCorrectnessHeavyChaos'
clearAfterTest = false
simBackupAgents = 'BackupToFile'
waitForQuiescenceEnd = false
runConsistencyCheck = false

    [[test.workload]]
    testName = 'Cycle'
    nodeCount = 30000
    transactionsPerSecond = 2500.0
    testDuration = 30.0
    expectedRate = 0

    [[test.workload]]
    testName = 'BackupS3BlobCorrectness'
    backupAfter = 35.0
    restoreAfter = 250.0
    abortAndRestartAfter = 0.0
    stopDifferentialAfter = 0.0
    performRestore = true
    backupRangesCount = -1
    skipDirtyRestore = false
    backupURL = 'blobstore://mocks3:mocksecret:mocktoken@127.0.0.1:8080/backup_container?bucket=backup_bucket&region=us-east-1&secure_connection=0&cwpf=1&cu=1'
    # Heavy chaos: aggressive testing with data corruption
    enableChaos = true
    errorRate = 0.25
    throttleRate = 0.30
    delayRate = 0.15
    corruptionRate = 0.01
    maxDelay = 10.0

    [[test.workload]]
    testName = 'RandomClogging'
    testDuration = 300.0

    [[test.workload]]
    testName = 'Rollback'
    meanDelay = 90.0
    testDuration = 300.0

