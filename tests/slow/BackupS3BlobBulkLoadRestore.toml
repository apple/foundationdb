# BulkLoad Validation Test
# Tests that BulkLoad restore produces identical results to traditional restore
#
# This test validates BulkLoad produces the same data as traditional restore:
# - Backup creates BOTH range files AND SST files (snapshotMode=2)
#   - Range files are used by traditional restore
#   - SST files are used by BulkLoad restore
# - Validation: compare BulkLoad restore vs traditional restore
#   1. Restore with --add-prefix to system keyspace using TRADITIONAL (rangefile) mode
#      This creates a "known good" baseline
#   2. Clear normalKeys (original data)
#   3. Restore to normalKeys using BULKLOAD mode (reads SST files)
#   4. Run audit_storage validate_restore to compare:
#      - BulkLoad-restored data (in normalKeys)
#      - Traditional-restored data (in system key prefix)
#   5. Clean up validation prefix data
# - This validates BulkLoad produces identical results to traditional restore
#
# Configuration aligned with working tests/slow/BulkDumpingS3.toml

testClass = "Backup"

[configuration]
storageEngineExcludeTypes = [5] # FIXME: remove after allowing bulkloading with fetchKey and shardedrocksdb
disableTss = true # TODO(BulkLoad): support TSS

# HA (multi-region) configuration - randomly enabled for test coverage
generateFearless = false
simpleConfig = false
minimumRegions = 1
# singleRegion not set - allows random HA configuration

# Ensure enough storage servers for non-overlapping BulkLoad teams
extraMachineCountDC = 3

# Explicit simple config - single replication, single region, explicit process counts
config = "triple usable_regions=1 storage_engine=ssd-2 perpetual_storage_wiggle=0 commit_proxies=3 grv_proxies=3 resolvers=3 logs=3"

# Disable buggify and fault injection to avoid interference with MockS3/BulkLoad
buggify = false
faultInjection = false

# Required knobs for BulkLoad functionality (from BulkDumpingS3.toml)
[[knobs]]
bulkload_sim_failure_injection = false
shard_encode_location_metadata = true
enable_read_lock_on_range = true
enable_version_vector = false
enable_version_vector_tlog_unicast = false
enable_version_vector_reply_recovery = false
min_byte_sampling_probability = 0.5
cc_enforce_use_unfit_dd_in_sim = true
disable_audit_storage_final_replica_check_in_sim = true
max_trace_lines = 5000000
# Allow more time for BulkDump job to complete (Linux runs 4x slower than macOS)
bulkdump_job_timeout = 1200
bulkload_job_timeout = 1200

# Disable buggified delays
[[flow_knobs]]
MAX_BUGGIFIED_DELAY = 0.0

# S3/Blobstore settings for stability/determinism
blobstore_max_connection_life = 300
blobstore_request_timeout_min = 300
blobstore_request_tries = 5
blobstore_connect_tries = 5
blobstore_connect_timeout = 30
http_send_size = 1024
http_read_size = 1024
connection_monitor_loop_time = 0.1
connection_monitor_timeout = 1.0
connection_monitor_idle_timeout = 60.0
dd_team_zero_server_left_log_delay = 0
dd_rebalance_parallelism = 1

[[test]]
testTitle = 'BackupS3BlobBulkLoadRestore'
useDB = true
clearAfterTest = false
simBackupAgents = 'BackupToFile'
waitForQuiescence = false
connectionFailuresDisableDuration = 1000000
runFailureWorkloads = false
timeout = 3600

    [[test.workload]]
    testName = 'Cycle'
    nodeCount = 100
    transactionsPerSecond = 100.0
    testDuration = 30.0
    expectedRate = 0

    [[test.workload]]
    testName = 'BackupS3BlobCorrectness'
    backupAfter = 10.0
    restoreAfter = 600.0
    abortAndRestartAfter = 0.0
    stopDifferentialAfter = 0.0
    performRestore = true
    backupRangesCount = -1
    skipDirtyRestore = false
    backupURL = 'blobstore://mocks3:mocksecret:mocktoken@127.0.0.1:8080/backup_container?bucket=backup_bucket&region=us-east-1&secure_connection=0&cwpf=1&cu=1'
    # BulkDump/BulkLoad integration options
    snapshotMode = 2           # 2 = BOTH (creates range files AND SST files for comparison)
    useRangeFileRestore = false # false = use BulkLoad for restore
    # Validation: Compare BulkLoad-restored vs traditional-restored using audit_storage validate_restore
    # Compares BulkLoad-restored (normalKeys) vs traditional-restored (prefix)
    performValidation = true
