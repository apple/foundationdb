<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Multimaps &#8212; FoundationDB 7.1</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '7.1.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multimaps" href="multimaps-java.html" />
    <link rel="prev" title="Hierarchical Documents" href="hierarchical-documents-java.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Multimaps</a><ul>
<li><a class="reference internal" href="#goal">Goal</a></li>
<li><a class="reference internal" href="#challenge">Challenge</a></li>
<li><a class="reference internal" href="#explanation">Explanation</a></li>
<li><a class="reference internal" href="#ordering">Ordering</a></li>
<li><a class="reference internal" href="#pattern">Pattern</a></li>
<li><a class="reference internal" href="#extensions">Extensions</a></li>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="hierarchical-documents-java.html" title="Previous Chapter: Hierarchical Documents"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Hierarchical ...</span>
    </a>
  </li>
  <li>
    <a href="multimaps-java.html" title="Next Chapter: Multimaps"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Multimaps &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Multimaps</a><ul>
<li><a class="reference internal" href="#goal">Goal</a></li>
<li><a class="reference internal" href="#challenge">Challenge</a></li>
<li><a class="reference internal" href="#explanation">Explanation</a></li>
<li><a class="reference internal" href="#ordering">Ordering</a></li>
<li><a class="reference internal" href="#pattern">Pattern</a></li>
<li><a class="reference internal" href="#extensions">Extensions</a></li>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="multimaps">
<h1>Multimaps</h1>
<p><strong>Python</strong> <a class="reference internal" href="multimaps-java.html"><span class="doc">Java</span></a></p>
<div class="section" id="goal">
<h2>Goal</h2>
<p>Create an <a class="reference external" href="http://en.wikipedia.org/wiki/Multimap">multimap</a> data structure with <a class="reference external" href="http://en.wikipedia.org/wiki/Multiset">multiset</a> values.</p>
</div>
<div class="section" id="challenge">
<h2>Challenge</h2>
<p>Support efficient operations on multimaps, including random addition, removal, and retrieval of indexed values.</p>
</div>
<div class="section" id="explanation">
<h2>Explanation</h2>
<p>Multimaps are a generalization of dictionaries (a.k.a. maps or associative arrays) in which each index can have multiple values. Multimaps can be further generalized by allowing a value to be present more than once for a given index, so that each index is associated with a multiset. These structures have a simple and efficient representation as FoundationDB&#8217;s key-value pairs.</p>
</div>
<div class="section" id="ordering">
<h2>Ordering</h2>
<p>We store all values of a given index using adjacent key-value pairs. This allows all values of an index to be retrieved with a single range read.</p>
</div>
<div class="section" id="pattern">
<h2>Pattern</h2>
<p>We store all values in the multimap within a subspace, which takes care of packing our keys into byte strings.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">multi</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">Subspace</span><span class="p">((</span><span class="s1">&#39;M&#39;</span><span class="p">,))</span>
</pre></div>
</div>
<p>Because we need to store multiple values per index, we&#8217;ll store them within keys, with each (index, value) pair in its own key. To implement the multiset we’ll record the number of occurrences of each value. This is done by storing a positive integer with the key using an atomic addition. Each addition of a given value for an index will increment the count by 1:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>By using a read-free atomic addition, FoundationDB guarantees that the addition operation will not conflict. As a result, values can be frequently added by multiple clients.</p>
<p>Subtracting values, on the other hand, requires a read to ensure that the value count does not fall below 0. (Hence, unlike additions, subtractions will be subject to conflicts.) We&#8217;ll just delete the key if a subtraction reduces the count to 0 in order to keep the representation sparse.</p>
</div>
<div class="section" id="extensions">
<h2>Extensions</h2>
<p><em>Negative value counts</em></p>
<p>We can generalize the representation further by allowing the count to be an arbitrary integer rather than restricting it to a positive integer. This extension may be useful for applications that record a deficit or debt of some resource. In this case, the code becomes even simpler and more efficient: we can simply remove the read and test from subtraction, making it conflict-free like the addition operation.</p>
</div>
<div class="section" id="code">
<h2>Code</h2>
<p>Here’s a simple implementation of multimaps with multisets as described:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">multi</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">Subspace</span><span class="p">((</span><span class="s1">&#39;M&#39;</span><span class="p">,))</span>

<span class="c1"># Multimaps with multiset values</span>
<span class="nd">@fdb</span><span class="o">.</span><span class="n">transactional</span>
<span class="k">def</span> <span class="nf">multi_add</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="nd">@fdb</span><span class="o">.</span><span class="n">transactional</span>
<span class="k">def</span> <span class="nf">multi_subtract</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">present</span><span class="p">()</span> <span class="ow">and</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">],</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">tr</span><span class="p">[</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">]]</span>

<span class="nd">@fdb</span><span class="o">.</span><span class="n">transactional</span>
<span class="k">def</span> <span class="nf">multi_get</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">multi</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">[</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">range</span><span class="p">()]]</span>

<span class="nd">@fdb</span><span class="o">.</span><span class="n">transactional</span>
<span class="k">def</span> <span class="nf">multi_get_counts</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">multi</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;q&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tr</span><span class="p">[</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">range</span><span class="p">()]}</span>

<span class="nd">@fdb</span><span class="o">.</span><span class="n">transactional</span>
<span class="k">def</span> <span class="nf">multi_is_element</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tr</span><span class="p">[</span><span class="n">multi</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">value</span><span class="p">]]</span><span class="o">.</span><span class="n">present</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/multimaps.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2021 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Nov 08, 2022.<br/>
    </p>
  </div>
</footer>
  </body>
</html>