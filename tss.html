<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Testing Storage Server (TSS) &#8212; FoundationDB 7.4.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="search" title="Search" href="search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.4.5</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Testing Storage Server (TSS)</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#configuring-tss">Configuring TSS</a><ul>
<li><a class="reference internal" href="#example-commands">Example commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-tss">Monitoring TSS</a><ul>
<li><a class="reference internal" href="#trace-events">Trace Events</a></li>
<li><a class="reference internal" href="#quarantined-tss">Quarantined TSS</a></li>
<li><a class="reference internal" href="#other-failure-types">Other Failure Types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-overview">Architecture Overview</a><ul>
<li><a class="reference internal" href="#tss-mapping">TSS Mapping</a></li>
<li><a class="reference internal" href="#recruitment">Recruitment</a></li>
<li><a class="reference internal" href="#tss-process">TSS Process</a></li>
</ul>
</li>
<li><a class="reference internal" href="#caveats">Caveats</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Testing Storage Server (TSS)</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#configuring-tss">Configuring TSS</a><ul>
<li><a class="reference internal" href="#example-commands">Example commands</a></li>
</ul>
</li>
<li><a class="reference internal" href="#monitoring-tss">Monitoring TSS</a><ul>
<li><a class="reference internal" href="#trace-events">Trace Events</a></li>
<li><a class="reference internal" href="#quarantined-tss">Quarantined TSS</a></li>
<li><a class="reference internal" href="#other-failure-types">Other Failure Types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture-overview">Architecture Overview</a><ul>
<li><a class="reference internal" href="#tss-mapping">TSS Mapping</a></li>
<li><a class="reference internal" href="#recruitment">Recruitment</a></li>
<li><a class="reference internal" href="#tss-process">TSS Process</a></li>
</ul>
</li>
<li><a class="reference internal" href="#caveats">Caveats</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <section id="testing-storage-server-tss">
<span id="testing-storage-server"></span><h1>Testing Storage Server (TSS)</h1>
<p>This document covers the operation and architecture of the Testing Storage Server feature, or TSS for short.</p>
<section id="summary">
<span id="tss-introduction"></span><h2>Summary</h2>
<p>The TSS feature allows FoundationDB to run an “untrusted” storage engine (the <em>testing storage engine</em>) directly in a QA or production environment with identical workload to the current storage engine, with zero impact on durability or correctness, and minimal impact on performance.</p>
<p>This allows a FoundationDB cluster operator to validate the correctness and performance of a different storage engine on the exact cluster workload before migrating data to the different storage engine.</p>
<p>A Testing Storage Server is paired to a normal Storage Server. Both servers in a new pair start empty and take on exactly the same data and serve exactly the same read requests. The SS and TSS responses are compared client-side to ensure that they match, and performance metrics are recorded for the pair.</p>
</section>
<section id="configuring-tss">
<h2>Configuring TSS</h2>
<p>You can configure TSS via the FDB <a class="reference internal" href="command-line-interface.html#command-line-interface"><span class="std std-ref">command line interface</span></a>.</p>
<p>Because of the performance overhead of duplicating and comparing read requests, it is recommended to configure the number of TSS processes to a small percentage of the number of storage processes in the cluster (at most 5% - 10%). It is also recommended to add enough servers to the cluster before enabling TSS to end up with the same number of normal Storage processes as the cluster had before enabling TSS.</p>
<p>Because TSS recruitment only pairs <em>new</em> storage processes, you must add processes to the cluster and/or enable the <em>perpetual wiggle</em> to actually start recruiting TSS processes.</p>
<section id="example-commands">
<h3>Example commands</h3>
<p>Set the desired TSS processes count to 4, using the redwood storage engine: <code class="docutils literal notranslate"><span class="pre">configure</span> <span class="pre">tss</span> <span class="pre">ssd-redwood-1</span> <span class="pre">count=4</span></code>.</p>
<p>Change the desired TSS process count to 2: <code class="docutils literal notranslate"><span class="pre">configure</span> <span class="pre">tss</span> <span class="pre">count=2</span></code>.</p>
<p>Disable TSS on the cluster: <code class="docutils literal notranslate"><span class="pre">configure</span> <span class="pre">tss</span> <span class="pre">count=0</span></code>.</p>
</section>
</section>
<section id="monitoring-tss">
<h2>Monitoring TSS</h2>
<p>The <code class="docutils literal notranslate"><span class="pre">status</span></code> command in the FDB <a class="reference internal" href="command-line-interface.html#command-line-interface"><span class="std std-ref">command line interface</span></a> will show the current and desired number of TSS processes in the cluster, and the full status JSON will include the full TSS configuration parameters.</p>
<section id="trace-events">
<h3>Trace Events</h3>
<p>Whenever a client detects a <em>TSS Mismatch</em>, or when the SS and TSS response differ, and the difference can only be explained by different storage engine contents, it will emit an error-level trace event with a type starting with <code class="docutils literal notranslate"><span class="pre">TSSMismatch</span></code>, with a different type for each read request. This trace event will include all of the information necessary to investigate the mismatch, such as the TSS storage ID, the full request data, and the summarized replies (full keys and checksummed values) from both the SS and TSS.</p>
<p>Each client emits a <code class="docutils literal notranslate"><span class="pre">TSSClientMetrics</span></code> trace event for each TSS pair in the cluster that it has sent requests to recently, similar to the <code class="docutils literal notranslate"><span class="pre">TransactionMetrics</span></code> trace event.
It contains the TSS storage ID, and latency statistics for each type of read request. It also includes a count of any mismatches, and a histogram of error codes received by the SS and TSS to ensure the storage engines have similar error rates and types.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">StorageMetrics</span></code> trace event emitted by storage servers includes the storage ID of its pair if part of a TSS pairing, and includes a <code class="docutils literal notranslate"><span class="pre">TSSJointID</span></code> detail with a unique id for the SS/TSS pair that enables correlating the separate StorageMetrics events from the SS and TSS.</p>
</section>
<section id="quarantined-tss">
<h3>Quarantined TSS</h3>
<p>If a <em>TSS Mismatch</em> is detected for a given TSS, instead of killing the TSS, it will be put into a <em>quarantined</em> state. In this state, the TSS doesn’t respond to any data requests, but is still recruited on the worker, preventing a new storage process from replacing it.
This is so that the cluster operator can investigate the storage engine file of the TSS’s <em>testing storage engine</em> to determine the cause of the data inconsistency.</p>
<p>You can also manually quarantine a TSS, or dispose of a quarantined TSS once you’re done investigating using the <code class="docutils literal notranslate"><span class="pre">tssq</span></code> command in the FDB <a class="reference internal" href="command-line-interface.html#command-line-interface"><span class="std std-ref">command line interface</span></a>.</p>
<p>The typical flow of operations would be</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tssq</span> <span class="pre">start</span> <span class="pre">&lt;StorageUID&gt;</span></code>: manually quarantines a TSS process, if it is not already quarantined.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tssq</span> <span class="pre">list</span></code>: lists all TSS processes currently in quarantine to see if any were automatically quarantined.</p></li>
<li><p>Investigate the quarantined TSS to determine the cause of the mismatch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tssq</span> <span class="pre">stop</span> <span class="pre">&lt;StorageUID&gt;</span></code>: remove a TSS process from quarantine, disposing of the TSS and allowing Data Distribution to recruit a new storage process on the worker.</p></li>
</ul>
<p>The Storage Consistency Check will also check TSS processes against the rest of that shard’s team, and fail if there is a mismatch, but it will not automatically quarantine the offending TSS.</p>
</section>
<section id="other-failure-types">
<h3>Other Failure Types</h3>
<p>The TSS feature is designed to insulate the cluster from an incorrect storage engine, but it is also designed to insulate the cluster as much as possible from a poor-performing storage engine.</p>
<p>Read Requests to TSS processes are never on the critical path for a client transaction, so a slow-responding TSS will not affect client latencies.</p>
<p>If the TSS falls behind its pair for ingesting new mutations or processing data movements, it will be killed by the cluster.</p>
</section>
</section>
<section id="architecture-overview">
<h2>Architecture Overview</h2>
<section id="tss-mapping">
<h3>TSS Mapping</h3>
<p>The <em>TSS Mapping</em>, the mapping containing the (SS Storage ID, TSS Storage ID) pairs for all active TSS pairs in the cluster, is stored in the system keyspace under <code class="docutils literal notranslate"><span class="pre">\xff/tss/</span></code>.</p>
<p>This information is lazily propagated to clients in the <code class="docutils literal notranslate"><span class="pre">KeyServerLocationsRequest</span></code> from the Commit Proxies, which read the TSS mapping from the Transaction State Store.</p>
<p>Clients will use this mapping to duplicate any request to a storage server that has a TSS pair.</p>
<p>Other cluster components that need the full, up-to-date TSS mapping (MoveKeys, ConsistencyCheck, etc…) read it directly from the system keyspace as part of a transaction.</p>
</section>
<section id="recruitment">
<h3>Recruitment</h3>
<p>TSS Pair recruitment is designed to use the <em>Perpetual Storage Wiggle</em>, but will also work if multiple storage processes are added to the cluster.</p>
<p>When Data Distribution detects a deficit of TSS processes in the cluster, it will begin recruiting a TSS pair.
The pair recruitment logic is as follows:</p>
<ul class="simple">
<li><p>Once DD gets a candidate worker from the Cluster Controller, hold that worker as a desired TSS process.</p></li>
<li><p>Once DD gets a second candidate worker from the Cluster Controller, initialize that worker as a normal SS.</p></li>
<li><p>Once the second candidate worker is successfully initialized, initialize the first candidate worker as a TSS, passing it the storage ID, starting tag + version, and other information from its SS pair. Because the TSS reads from the same tag starting at the same version, it is guaranteed to receive the same mutations and data movements as its pair.</p></li>
</ul>
<p>One implication of this is, during TSS recruitment, the cluster is effectively down one storage process until a second storage process becomes available.
While clusters should be able to handle being down a single storage process anyway to tolerate machine failure, an active TSS recruitment will be cancelled if the lack of that single storage process is causing the cluster to be unhealthy. Similarly, if the cluster is unhealthy and unable to find new teams to replicate data to, any existing TSS processes may be killed to make room for new storage servers.</p>
</section>
<section id="tss-process">
<h3>TSS Process</h3>
<p>A TSS process is almost identical to a normal Storage process, with the exception that it does not pop its tag from the TLog mutation stream, and it listens to and processes private mutations for both itself and its SS pair.</p>
</section>
</section>
<section id="caveats">
<h2>Caveats</h2>
<p>Despite its usefulness, the TSS feature does not give a perfect performance comparison of the storage engine(s) under test.</p>
<p>Because it is only enabled on a small percentage of the cluster and only compares single storage processes for the same workload, it may miss potential aggregate performance problems, such as the testing storage engine overall consuming more cpu/memory, especially on a host with many storage instances.</p>
<p>TSS testing using the recommended small number of TSS pairs may also miss performance pathologies from workloads not experienced by the specific storage teams with TSS pairs in their membership.</p>
<p>TSS testing is not a substitute for full-cluster performance and correctness testing or simulation testing.</p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/tss.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2025 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Sep 13, 2025.<br/>
    </p>
  </div>
</footer>
  </body>
</html>