name: Prometheus E2E Test

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master", "feature/prometheus-metrics-endpoint" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-rhel9:
    name: Linux RHEL 9
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Build in RHEL 9 Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace foundationdb/build:rockylinux9-latest /bin/bash -c "
            dnf install -y 'dnf-command(config-manager)' &&
            dnf config-manager --set-enabled crb || true &&
            dnf install -y epel-release || true &&
            dnf install -y git cmake ninja-build gcc-c++ &&
            mkdir build &&
            cd build &&
            cmake -G Ninja -DOLD_FDB_alloc_instrumentation=ON .. &&
            ninja -j1 fdbserver &&
            ./bin/fdbserver -r simulation -f ../tests/fast/PrometheusMetrics.toml -b on
          "

  test-centos7:
    name: Linux CentOS 7
    needs: test-rhel9
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Build in CentOS 7 Docker
        run: |
          # Run the build inside the container using docker run to avoid GH Actions Node.js issues
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace foundationdb/build:centos7-latest /bin/bash -c "
            source /opt/rh/devtoolset-11/enable &&
            yum install -y epel-release &&
            yum install -y cmake3 ninja-build &&
            ln -sf /usr/bin/cmake3 /usr/bin/cmake &&
            mkdir -p build &&
            cd build &&
            cmake -G Ninja -DOLD_FDB_alloc_instrumentation=ON .. &&
            ninja -j2 fdbserver &&
            ./bin/fdbserver -r simulation -f ../tests/fast/PrometheusMetrics.toml -b on
          "

  test-macos:
    name: macOS (Latest)
    needs: test-centos7
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
            brew install cmake ninja boost openssl@3

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G Ninja -DOLD_FDB_alloc_instrumentation=ON -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) ..

      - name: Build fdbserver
        run: |
          cd build
          ninja -j2 fdbserver

      - name: Run Prometheus Simulation Test
        run: |
          cd build
          ./bin/fdbserver -r simulation -f ../tests/fast/PrometheusMetrics.toml -b on
