<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using FoundationDB Clients &#8212; FoundationDB 7.1</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '7.1.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Transaction Tagging" href="transaction-tagging.html" />
    <link rel="prev" title="Client Testing" href="client-testing.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Using FoundationDB Clients</a><ul>
<li><a class="reference internal" href="#versioning">Versioning</a><ul>
<li><a class="reference internal" href="#api-versions">API versions</a></li>
<li><a class="reference internal" href="#binary-versions">Binary versions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cluster-file">Cluster file</a></li>
<li><a class="reference internal" href="#installing-foundationdb-client-binaries">Installing FoundationDB client binaries</a></li>
<li><a class="reference internal" href="#multi-version-client">Multi-version client</a></li>
<li><a class="reference internal" href="#setting-network-options-with-environment-variables">Setting network options with environment variables</a></li>
<li><a class="reference internal" href="#client-network-thread">Client network thread</a><ul>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multi-threaded-client">Multi-threaded Client</a></li>
<li><a class="reference internal" href="#client-trace-logging">Client trace logging</a><ul>
<li><a class="reference internal" href="#client-trace-logging-multi-version-client">Multi-version client API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="client-testing.html" title="Previous Chapter: Client Testing"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Client Testing</span>
    </a>
  </li>
  <li>
    <a href="transaction-tagging.html" title="Next Chapter: Transaction Tagging"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Transaction Tagging &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Using FoundationDB Clients</a><ul>
<li><a class="reference internal" href="#versioning">Versioning</a><ul>
<li><a class="reference internal" href="#api-versions">API versions</a></li>
<li><a class="reference internal" href="#binary-versions">Binary versions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cluster-file">Cluster file</a></li>
<li><a class="reference internal" href="#installing-foundationdb-client-binaries">Installing FoundationDB client binaries</a></li>
<li><a class="reference internal" href="#multi-version-client">Multi-version client</a></li>
<li><a class="reference internal" href="#setting-network-options-with-environment-variables">Setting network options with environment variables</a></li>
<li><a class="reference internal" href="#client-network-thread">Client network thread</a><ul>
<li><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multi-threaded-client">Multi-threaded Client</a></li>
<li><a class="reference internal" href="#client-trace-logging">Client trace logging</a><ul>
<li><a class="reference internal" href="#client-trace-logging-multi-version-client">Multi-version client API</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="using-foundationdb-clients">
<h1>Using FoundationDB Clients</h1>
<div class="section" id="versioning">
<span id="id1"></span><h2>Versioning</h2>
<p>FoundationDB supports a robust versioning system for both its API and binaries. This system allows clusters to be upgraded with minimal changes to both application code and FoundationDB binaries. The API and the FoundationDB binaries are each released in numbered versions. Each version of the binaries has a corresponding API version.</p>
<div class="section" id="api-versions">
<span id="id2"></span><h3>API versions</h3>
<p>In general, a given client will support both its corresponding API version <em>and earlier API versions</em>. A client selects the API version it will use by explicitly specifying the version number upon initialization. The purpose of this design is to allow the server, client libraries, or bindings to be upgraded without having to modify application code. You can therefore upgrade to more recent packages (and so receive their various improvements) without having to change application code.</p>
</div>
<div class="section" id="binary-versions">
<h3>Binary versions</h3>
<p>By default, client and server binaries installed for a given cluster must have the same version. However, there is also a multi-version feature that allows a client to connect to a cluster whose server processes have a different version. This feature works by loading a separate client library that is version-compatible with the cluster, which then proxies all API calls.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The interaction between API versions and binary versions follows a simple rule: <em>the API version cannot be set higher than that supported by the client library in use</em>, including any client library loaded using the multi-version feature.</p>
</div>
<p>For more details, see <a class="reference internal" href="api-python.html#api-python-versioning"><span class="std std-ref">API versioning</span></a> and <a class="reference internal" href="#multi-version-client-api"><span class="std std-ref">Multi-version client</span></a>.</p>
</div>
</div>
<div class="section" id="cluster-file">
<h2>Cluster file</h2>
<p>FoundationDB servers and clients use a cluster file (typically named <code class="docutils literal"><span class="pre">fdb.cluster</span></code>) to connect to a cluster. The contents of the cluster file are the same for all processes that connect to the cluster. When connecting to a cluster, the <a class="reference internal" href="api-reference.html"><span class="doc">client APIs</span></a> allow a cluster file to either be explicitly provided or automatically determined by default. For example, using the Python API:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;/path/to/specific/file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>uses only the specified file and errors if it is invalid. In contrast:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</pre></div>
</div>
<p>checks the <code class="docutils literal"><span class="pre">FDB_CLUSTER_FILE</span></code> environment variable, then the current working directory, then the <a class="reference internal" href="administration.html#default-cluster-file"><span class="std std-ref">default file</span></a>. FoundationDB&#8217;s procedure for determining a cluster file is described in <a class="reference internal" href="administration.html#specifying-a-cluster-file"><span class="std std-ref">Specifying a cluster file</span></a>.</p>
</div>
<div class="section" id="installing-foundationdb-client-binaries">
<span id="installing-client-binaries"></span><h2>Installing FoundationDB client binaries</h2>
<p>To access a FoundationDB cluster from a machine that won&#8217;t need to run the server, you can install just the FoundationDB client binaries (available for download at <a class="reference internal" href="downloads.html"><span class="doc">Downloads</span></a>).</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Unless using the <a class="reference internal" href="#multi-version-client-api"><span class="std std-ref">Multi-version client</span></a>, the installed client and server packages must have the same version. When upgrading a FoundationDB cluster, be sure also to upgrade all clients to the same version.</p>
</div>
<p>If you don&#8217;t already have a FoundationDB cluster to connect to, you should instead follow the instructions in <a class="reference internal" href="getting-started-mac.html"><span class="doc">Getting Started on macOS</span></a> or <a class="reference internal" href="getting-started-linux.html"><span class="doc">Getting Started on Linux</span></a>.</p>
<p>To install on <strong>Ubuntu</strong> use the dpkg command:</p>
<pre class="literal-block">
user&#64;host$ sudo dpkg -i foundationdb-clients_7.1.25-1_amd64.deb
</pre>
<p>To install on <strong>RHEL/CentOS</strong> use the rpm command:</p>
<pre class="literal-block">
user&#64;host$ sudo rpm -Uvh foundationdb-clients-7.1.25-1.el7.x86_64.rpm
</pre>
<p>To install on <strong>macOS</strong>, run the installer as in <a class="reference internal" href="getting-started-mac.html"><span class="doc">Getting Started on macOS</span></a>, but deselect the &#8220;FoundationDB Server&#8221; feature.</p>
<p>The client binaries include the <code class="docutils literal"><span class="pre">fdbcli</span></code> tool and language bindings for C.  Other language bindings must be installed separately.</p>
<p>Clients will also need a <a class="reference internal" href="administration.html#foundationdb-cluster-file"><span class="std std-ref">cluster file</span></a> to connect to a FoundationDB cluster.  You should copy the <code class="docutils literal"><span class="pre">fdb.cluster</span></code> file from the <a class="reference internal" href="administration.html#default-cluster-file"><span class="std std-ref">default location</span></a> on one of your FoundationDB servers to the default location on the client machine.</p>
</div>
<div class="section" id="multi-version-client">
<span id="multi-version-client-api"></span><h2>Multi-version client</h2>
<p>The FoundationDB client library supports connecting to clusters with server processes running at a different version than the client. To do so, it must have access to a version of the client compatible with the cluster, which it loads and then proxies API calls through.</p>
<p>To make use of the multi-version client capabilities, you must set at least one of two network options (<code class="docutils literal"><span class="pre">EXTERNAL_CLIENT_LIBRARY</span></code> and/or <code class="docutils literal"><span class="pre">EXTERNAL_CLIENT_DIRECTORY</span></code>) that specify the location of these additional client libraries. The client library will start a new <a class="reference internal" href="#client-network-thread"><span class="std std-ref">network thread</span></a> for each external client and attempt to make connections to the cluster over all of them (as well as the local library). When making API calls, the library will use the version that is able to communicate with the cluster (choosing an arbitrary one if there are multiple compatible clients), and it will also automatically switch to the appropriate client should the cluster&#8217;s protocol version change. Each loaded library will generate its own <a class="reference internal" href="#client-trace-logging-multi-version-client"><span class="std std-ref">trace files</span></a>, if enabled.</p>
<p>The multi-version client API adds a new <code class="docutils literal"><span class="pre">cluster_version_changed</span></code> error that is used to cancel operations performed by the client when it switches to using a different version of the client library. This error is a retryable one, meaning that all standard retry loops will automatically rerun a transaction that fails with <code class="docutils literal"><span class="pre">cluster_version_changed</span></code>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Setting an API version that is not supported by a particular client library will prevent that client from being used to connect to the cluster. In particular, you should not advance the API version of your application after upgrading your client until the cluster has also been upgraded.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You should avoid including multiple protocol-compatible clients in the external client libraries list. While the client will still work, it will consume more resources than necessary. Additionally, different patch releases of the same version (e.g. <code class="docutils literal"><span class="pre">x.y.z</span></code> and <code class="docutils literal"><span class="pre">x.y.w</span></code>) are protocol compatible, and including multiple may result in not using the most recent compatible client.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is recommended that you not include more external clients than necessary. For example, a client that has been upgraded to a newer version than its cluster may need to include a single external client that matches the version of the cluster, but it generally won&#8217;t require a copy of every prior version.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If <code class="docutils literal"><span class="pre">cluster_version_changed</span></code> is thrown during commit, it should be interpreted similarly to <code class="docutils literal"><span class="pre">commit_unknown_result</span></code>. The commit may or may not have been completed.</p>
</div>
</div>
<div class="section" id="setting-network-options-with-environment-variables">
<span id="network-options-using-environment-variables"></span><h2>Setting network options with environment variables</h2>
<p>Client network options can be set automatically upon client startup using specially crafted environment variables. To set a particular network option, add a variable of the following form to your environment:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FDB_NETWORK_OPTION_</span><span class="o">&lt;</span><span class="n">UPPERCASE_OPTION_NAME</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>
</div>
<p>For example, you can enable trace logging for a client by setting the following environment variable:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FDB_NETWORK_OPTION_TRACE_ENABLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>If you want to set the same option multiple times (e.g. to add multiple client libraries, for instance), you can separate the values with the default path separator on your system (<code class="docutils literal"><span class="pre">:</span></code> on Linux/macOS, <code class="docutils literal"><span class="pre">;</span></code> on Windows). For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">FDB_NETWORK_OPTION_EXTERNAL_CLIENT_DIRECTORY</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">dir1</span><span class="p">:</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">dir2</span><span class="p">:</span><span class="o">...</span>
</pre></div>
</div>
<p>Network options specified using environment variables are set at the end of the call to set the API version. They will be applied in the order of the corresponding option codes assigned to the options. If there is an error reading the appropriate environment variables or if the option cannot be set with the specified value, then the call to set the API version may return an error. In that case, you may attempt to set the API version again, but you must do so with the same version as the attempt that failed.</p>
</div>
<div class="section" id="client-network-thread">
<span id="id3"></span><h2>Client network thread</h2>
<p>FoundationDB clients start a thread that is used to serialize operations and communicate with the cluster. This thread is commonly referred to as the network thread, and most operations performed by a client (such as reads, writes, and commits) will take place on this thread. It is important that a client application does not block on this thread, such as by issuing a blocking call in a callback from a FoundationDB operation. Some client language bindings (e.g. Java) will protect you from this risk by notifying the application that an operation has completed from a different thread automatically.</p>
<p>A client process can have <em>only one</em> network thread for the entire lifetime of that process. While it&#8217;s possible to stop the network thread, it is not possible to restart it.</p>
<div class="section" id="performance">
<span id="client-network-thread-performance"></span><h3>Performance</h3>
<p>Because it can have only a single network thread, a client process may become limited in its throughput by the amount of work that can be performed on that thread. A client with a saturated network thread may begin to experience increased latencies while it struggles to keep up. If a client application needs to support higher throughput than a single network thread can provide, then more network threads can be started by running additional client processes.</p>
<p>If you suspect that a client process&#8217;s workload may be saturating the network thread, this can be confirmed by checking whether the network thread is running with high CPU usage. In the <a class="reference internal" href="#client-trace-logging"><span class="std std-ref">client trace logs</span></a>, the <code class="docutils literal"><span class="pre">ProcessMetrics</span></code> trace event has a field for <code class="docutils literal"><span class="pre">MainThreadCPUSeconds</span></code> that indicates the number of seconds out of <code class="docutils literal"><span class="pre">Elapsed</span></code> that the network thread was busy. You can also attempt to identify a busy thread from any tool that reports the CPU activity of threads in your process.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">FoundationDB 6.3 introduced <a class="reference internal" href="#multi-threaded-client"><span class="std std-ref">multi-threaded client</span></a>, and can alternatively be used to scale clients.</p>
</div>
</div>
</div>
<div class="section" id="multi-threaded-client">
<span id="id4"></span><h2>Multi-threaded Client</h2>
<p>FoundationDB client library can start multiple worker threads for each version of client that is loaded.</p>
<p>Currently, each database object is associated with exactly one of the threads, so a user would need at least <code class="docutils literal"><span class="pre">N</span></code> database objects to make use of <code class="docutils literal"><span class="pre">N</span></code> threads. Additionally, some language bindings (e.g. the python bindings) cache database objects by cluster file, so users may need multiple cluster files to make use of multiple threads. This may be improved in the future.</p>
<p>Clients can be configured to use worker-threads by setting the <code class="docutils literal"><span class="pre">FDBNetworkOptions::CLIENT_THREADS_PER_VERSION</span></code> option.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In order to use the multi-threaded client feature, you must configure at
least one external client. See <a class="reference internal" href="#multi-version-client-api"><span class="std std-ref">multi-version client API</span></a> for how to configure an external client.</p>
</div>
</div>
<div class="section" id="client-trace-logging">
<span id="id5"></span><h2>Client trace logging</h2>
<p>By default, clients do not generate trace logs. In order to enable them, the <code class="docutils literal"><span class="pre">TRACE_ENABLE</span></code> network option must be set on your client. See the documentation for your language binding for instructions on how to do this.</p>
<div class="section" id="client-trace-logging-multi-version-client">
<span id="id6"></span><h3>Multi-version client API</h3>
<p>When trace logs are enabled while using the <a class="reference internal" href="#multi-version-client-api"><span class="std std-ref">multi-version client API</span></a>, separate files will be generated for the primary client library and each of the loaded external clients. The <code class="docutils literal"><span class="pre">ClientStart</span></code> event can be used to identify the version of the client that generated a particular log file. Most of the relevant logs will be found in the version that matches the cluster&#8217;s version, but for some types of issues with startup or upgrades (particularly those related to the multi-version client itself), relevant logs can be found in the logs for the primary client as well.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/api-general.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2021 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Nov 08, 2022.<br/>
    </p>
  </div>
</footer>
  </body>
</html>