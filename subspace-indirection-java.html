<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Subspace Indirection &#8212; FoundationDB 7.1</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '7.1.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tables" href="tables.html" />
    <link rel="prev" title="Subspace Indirection" href="subspace-indirection.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          FoundationDB</a>
        <span class="navbar-text navbar-version pull-left"><b>7.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="contents.html">Site Map</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Subspace Indirection</a><ul>
<li><a class="reference internal" href="#goal">Goal</a></li>
<li><a class="reference internal" href="#challenge">Challenge</a></li>
<li><a class="reference internal" href="#explanation">Explanation</a></li>
<li><a class="reference internal" href="#ordering">Ordering</a></li>
<li><a class="reference internal" href="#pattern">Pattern</a></li>
<li><a class="reference internal" href="#extensions">Extensions</a></li>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="subspace-indirection.html" title="Previous Chapter: Subspace Indirection"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Subspace Indirection</span>
    </a>
  </li>
  <li>
    <a href="tables.html" title="Next Chapter: Tables"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Tables &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Subspace Indirection</a><ul>
<li><a class="reference internal" href="#goal">Goal</a></li>
<li><a class="reference internal" href="#challenge">Challenge</a></li>
<li><a class="reference internal" href="#explanation">Explanation</a></li>
<li><a class="reference internal" href="#ordering">Ordering</a></li>
<li><a class="reference internal" href="#pattern">Pattern</a></li>
<li><a class="reference internal" href="#extensions">Extensions</a></li>
<li><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="subspace-indirection">
<h1>Subspace Indirection</h1>
<p><a class="reference internal" href="subspace-indirection.html"><span class="doc">Python</span></a> <strong>Java</strong></p>
<div class="section" id="goal">
<h2>Goal</h2>
<p>Employ subspace indirection to manage bulk inserts or similar long-running operations.</p>
</div>
<div class="section" id="challenge">
<h2>Challenge</h2>
<p>Some large or long operations, such as bulk inserts, cannot be handled in a single FoundationDB transaction because the database does not support transactions over five seconds.</p>
</div>
<div class="section" id="explanation">
<h2>Explanation</h2>
<p>We can handle long-running operations using a distinct subspace to hold a temporary copy of the data. The new subspace is transactionally moved into place upon completion of the writes. We can perform the move quickly because the client accesses the subspaces through managed references.</p>
<p>FoundationDB <a class="reference internal" href="developer-guide.html#developer-guide-directories"><span class="std std-ref">directories</span></a> provide a convenient method to indirectly reference subspaces. Each directory is identified by a path that is mapped to a prefix for a subspace. The indirection from paths to subspaces makes it fast to move directories by renaming their paths.</p>
</div>
<div class="section" id="ordering">
<h2>Ordering</h2>
<p>The ordering of keys applies within each directory subspace for whatever data model is used by the application. However, directory subspaces are independent of each other, and there is no meaningful ordering between them.</p>
</div>
<div class="section" id="pattern">
<h2>Pattern</h2>
<p>For a single client, we can use a simple Workspace class to handle creation of a new subspace and transactionally swapping it into place. Rather than working with a subspace directly, a client accesses the current subspace through a managed reference as follows:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">Database</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdb</span><span class="p">.</span><span class="na">open</span><span class="p">();</span><span class="w"></span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">DirectorySubspace</span><span class="o">&gt;</span><span class="w"> </span><span class="n">workingDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DirectoryLayer</span><span class="p">.</span><span class="na">getDefault</span><span class="p">().</span><span class="na">createOrOpen</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;working&quot;</span><span class="p">));</span><span class="w"></span>
<span class="n">Workspace</span><span class="w"> </span><span class="n">workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Workspace</span><span class="p">(</span><span class="n">workingDir</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span><span class="w"> </span><span class="n">db</span><span class="p">);</span><span class="w"></span>
<span class="kd">final</span><span class="w"> </span><span class="n">DirectorySubspace</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">workspace</span><span class="p">.</span><span class="na">getCurrent</span><span class="p">().</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>The client performs transactions on data in the subspace current in the usual manner. When we want a new workspace for a bulk load or other long-running operation, we create one with a workspace:</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">final</span><span class="w"> </span><span class="n">DirectorySubspace</span><span class="w"> </span><span class="n">newspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">workspace</span><span class="p">.</span><span class="na">getNew</span><span class="p">().</span><span class="na">get</span><span class="p">();</span><span class="w"></span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">clearSubspace</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="w"> </span><span class="n">newspace</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">db</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">tr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">newspace</span><span class="p">.</span><span class="na">pack</span><span class="p">(</span><span class="n">Tuple</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">Tuple</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">).</span><span class="na">pack</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">newspace</span><span class="p">.</span><span class="na">pack</span><span class="p">(</span><span class="n">Tuple</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span><span class="w"> </span><span class="n">Tuple</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">).</span><span class="na">pack</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Asynchronous operation--wait until result is reached.</span><span class="w"></span>
<span class="w">    </span><span class="n">workspace</span><span class="p">.</span><span class="na">replaceWithNew</span><span class="p">().</span><span class="na">blockUntilReady</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>When the workspace completes, it transactionally replaces the current subspace with the new one.</p>
</div>
<div class="section" id="extensions">
<h2>Extensions</h2>
<p><em>Multiple Clients</em></p>
<p>Beyond the ability to load and transactionally swap in a single new data set, an application may want to support multiple clients concurrently performing long-running operations on a data set. In this case, the application could perform optimistic validation of an operation before accepting it.</p>
</div>
<div class="section" id="code">
<h2>Code</h2>
<p>Here&#8217;s a simple Workspace class for swapping in a new workspace supporting the basic usage above.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Workspace</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">db</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">DirectorySubspace</span><span class="w"> </span><span class="n">dir</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Workspace</span><span class="p">(</span><span class="n">DirectorySubspace</span><span class="w"> </span><span class="n">directory</span><span class="p">,</span><span class="w"> </span><span class="n">Database</span><span class="w"> </span><span class="n">db</span><span class="p">){</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">directory</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">db</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">DirectorySubspace</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCurrent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="na">createOrOpen</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">db</span><span class="p">,</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;current&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">DirectorySubspace</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getNew</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="na">createOrOpen</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">db</span><span class="p">,</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;new&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">DirectorySubspace</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">replaceWithNew</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">db</span><span class="p">.</span><span class="na">runAsync</span><span class="p">(</span><span class="n">tr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;current&quot;</span><span class="p">))</span><span class="w"> </span><span class="c1">// Clear the old current.</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="na">flatMap</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Replace the old directory with the new one.</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="na">move</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;new&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">PathUtil</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;current&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/subspace-indirection-java.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013-2021 Apple, Inc and the FoundationDB project authors.<br/>
      Last updated on Nov 08, 2022.<br/>
    </p>
  </div>
</footer>
  </body>
</html>